# BIG-IP AFM (Advanced Firewall Manager) Workbook

## Introduction
BIG-IP in Azure uses [Telemetry Streaming](https://clouddocs.f5.com/products/extensions/f5-telemetry-streaming/latest/) to declaratively aggregate, normalize, and forward statistics and events from the BIG-IP to a consumer application. BIG-IP Telemetry Streaming is an iControl LX Extension delivered as a TMOS-independent RPM file. The RPM is available [here](https://github.com/F5Networks/f5-telemetry-streaming/tree/master).

You can do all of this by POSTing a single TS JSON declaration to BIG-IP Telemetry Streaming’s declarative REST API endpoint. The BIG-IP Telemetry Streaming Event Listener collects event logs it receives on the specified port from configured BIG-IP sources, including LTM, ASM, AFM, APM, and AVR.

The [Advanced Firewall Manager](https://www.f5.com/products/big-ip-services/advanced-firewall-manager) is a high-performance, full-proxy network security solution designed to protect against incoming threats that enter the network. Additionally, with BIG-IP AFM, IDS/IPS (Intrusion Detection and Prevention Services) provides over 100 attack signatures and compliance checks to protect incoming traffic as part of the 'Protocol Inspection' service.

We redirect logs to the localhost on port 6514 as it will then be picked up by the `Telemetry-System` listener and pushed out to Azure Log Analytics:
```
"My_Listener": {
   "class": "Telemetry_Listener",
   "port": 6514
}
```
> :memo: **Reference:** https://clouddocs.f5.com/products/extensions/f5-telemetry-streaming/latest/event-listener.html

This workbook provides analysis of the AFM logs which are streaming by TS into Azure. The workbook can be added to the Azure portal and will search and display AFM data. The workbook has only been designed using a **Global** AFM policy (one assigned at the [global context](https://techdocs.f5.com/kb/en-us/products/big-ip-afm/manuals/product/big-ip-network-firewall-policies-and-implementations-14-1-0/06.html) rather than Self-IP, Virtual Server, or Route Domain level). I believe it should work with these other contexts as well, but may need some tweaking.

## BIG-IP Configuration
To enable AFM logging for the global context, you need to update the Security Log Profile for the `global-network` policy in: **Security  ››  Event Logs : Logging Profiles** in the GUI. Here you need to specify your Log Publisher which connects to the internal listener.

## Log Analytics Logs
Once it has been enabled, you should shortly see a table created in Azure in your log analytics workspace for AFM:
![afm_customlog](/images/afm_customlog.png)


## Workbook
The workbook provided here can be uploaded to provide a easier way to view and report on AFM events. It has the following features:

* Can select subscriptions and multiple workspaces so if you have BIG-IP devices in different subscriptions, the report can correlate all this data into one.
* Allows you to visualize data across different time periods.
* Provides a global view of firewall activity across your entire estate of BIG-IP devices.
   * Any device which is found across all the subscriptions you have access to is scanned for AFM log data
* Visualizes policy hits and matches with virtual servers where possible.
   * To match with a virtual server also requires the BIG-IP device to be outputting the *F5Telemetry_virtualServers_CL* log (part of System polling).
* Provides Traffic Analysis
   * Hits per rule
   * Hits per IP Address
   * Rejections by Source IP
   * Top 10 Rejections

The workbook also analyses any Protocol Inspection logs and reports on any violations which have been detected

* Summary of all Intrusion Detection Events in the time period.
* Detail of specific violations which were recorded over the time period.
* Analysis of violations and a summary of the attack event and the impacted service (by Virtual Server).

### Summary and Filtering
The first task to get data into the workbook is to select an appropriate subscription and Log Analytics Workspace which contains the `F5Telemetry_AFM_CL` custom log which is generated by the Telemetry Streaming service sending AFM log data into Azure.

![alt text](/images/afm_insights.png)

When the correct workspace has been selected, the workbook will generate a global summary using tiles with spark bars. The identification of devices is performed by searching for any devices across all the subscriptions in the tenant which the user has access to  

### Drill into Events
The *Policy Matches over Time Period* graph provides a view of events over the selected time period.

**Example Showing Time Graph of AFM Events (with time brush slicer)**
![Time Graph of AFM Events](/images/afm_slice.png)

The time graph over the selected period can be brushed using your cursor to select a time interval within the main interval, if you spot an interesting period within the time graph and only wish to see what logs were created at this period. In the top right there is a small icon: <img src="/images/syslog_graph_reset_icon.png" width="400" /> which allows you to reset the time range selection. Once selected, all the *Traffic Analysis* graphics will update to that specific period only.

